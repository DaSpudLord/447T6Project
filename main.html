<!DOCTYPE html>



<html lang="en">
	<head>
		<title>COVID Map</title>
		<meta charset="utf-8">

		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
			  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
			  crossorigin="" />
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
				integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
				crossorigin=""></script>

		<link rel="stylesheet" href="styles.css" />
		<script src="scripts.js"></script>
		<script src="data.js"></script> <!-- TODO: VERY TEMPORARY TESTING DATA -->

		<style>
			html, body {
				height: 100%; /* This makes the page conform to the user's vertical screen space */
				max-height: 100%;
				font-family: Arial, Helvetica, sans-serif
			}
			body {
				margin: 0px;
				display: flex; /* Making the body into a vertical flexbox allows the height of the page-content to fit the screen size */
				flex-direction: column;
				align-items: stretch;
			}
			.header {
				min-height: min-content; /* Header has a fixed height */
				flex: 0;
				border-bottom: 1px solid black;
			}
			.page-content {
				min-height: 0; /* This prevents the page content from overflowing its container and making the entire page scroll
					(possible if the sidebar's content overflows the sidebar). I have no fucking idea why this works but it does */
				flex: 1; /* Page content takes up all vertical space not being used by the header */
				display: flex;
				flex-direction: row; /* The page content is itself a (horizontal) flexbox consisting of the map and the sidebar */
				align-items: stretch;
			}
			.leafmap {
				height: 100%;
				flex: 3; /* The leafmap will take up approx 3/4ths of the horizontal space of the page */
			}
			.leafmap-sidebar {
				height: 100%;
				min-width: 350px; /* Don't let the sidebar shrink too much, TODO: Replace with min-content once the sidebar has stuff in it? */
				flex: 1; /* The sidebar will take up approx 1/4ths of the horizontal space of the page */
				border-left: 1px solid black;
				overflow: auto; /* If the sidebar's content overflows the sidebar,
					make a scrollbar localized to the sidebar rather than making the entire page scroll */
			}
		</style>
	</head>
	
	<body>
		<!-- Header -->
		<nav class="header">
			<h1 style="margin:12px">COVID-19 Data Map</h1>
			<!-- This is where the title, navbar, and related stuff can go -->
		</nav>

		<!-- PAGE CONTENT -->
		<div class="page-content">
			<!-- The actual map -->
			<div id="map-main" class="leafmap"></div>

			<!-- The right info panel -->
			<div class="leafmap-sidebar">
				<div style="margin:12px">
					<h1 id="region-title" style="margin:0"></h1>
					<p id="region-fips" style="margin:0" hidden>Fips Code: <span id="region-fips-code"></span></p>
				</div>

				<div class="tab-bar">
					<button id="tab-button-back" onclick="setActiveRegionParent(region_active)" hidden>&lt;</button>
					<button id="tab-button-stats" onclick="tabClickSelect(this, 'tab-content', 'tab-content-stats')">Statistics</button>
					<button id="tab-button-list" onclick="tabClickSelect(this, 'tab-content', 'tab-content-list')">List of Counties</button>
					<div></div> <!-- empty div lets me do fancy stuff with borders teehee -->
				</div>

				<div id="tab-content-stats" class="tab-content">
					<p style="margin:12px">Last updated <span id="stats-date">N/E/VER</span></p>
					<p style="margin:16px;margin-top:0;font-size:20px;line-height:150%">
						Cases: <span id="stats-cases"></span><br />
						Deaths: <span id="stats-deaths"></span><br />
						Vaccinations: <span id="stats-vaccinations"></span>
					</p>
				</div>

				<div id="tab-content-list" class="tab-content" hidden>
					<div style="margin:8px">
						<label>
							Sort By: <!-- TODO: Implement sorting -->
							<select id="sort-by">
								<option value="name">Name</option>
								<option value="cases">Cases</option>
								<option value="deaths">Deaths</option>
								<option value="vaccinations">Vaccinations</option>
							</select>
						</label>
						<label style="border-left:1px solid black"><input type="checkbox" id="sort-descending" checked />Descending Order</label>
					</div>

					<div id="region-list" class="button-list">
						<!-- TEMPLATE LIST ITEM - This is captured as a template by the js
							 and cloned to make all the actual list elements -->
						<button onclick="setActiveRegionByFips(dataset.fips)">
							<p class="region-list-name" style="margin:0"></p>
							<div style="flex:1"></div> <!-- Empty space -->
							<p class="region-list-data" style="margin:0"></p>
						</button>
					</div>
				</div>
			</div>
		</div>
		
		<script>
			const MAP_MAIN = L.map("map-main");
			const MAP_MAIN_GEO = L.geoJSON(null, { onEachFeature: onEachRegionFeature }).addTo(MAP_MAIN);
			var region_active = null;

			L.control.layers(
				{
					"Streets": getMapboxTiles("streets-v11").addTo(MAP_MAIN), // This one's the default
					"Outdoors": getMapboxTiles("outdoors-v11"),
					"Light": getMapboxTiles("light-v10"),
					"Dark": getMapboxTiles("dark-v10"),
					"Satellite": getMapboxTiles("satellite-v9"),
					"Satellite Streets": getMapboxTiles("satellite-streets-v11"),
					"Navigation Day": getMapboxTiles("navigation-day-v1"),
					"Navigation Night": getMapboxTiles("navigation-night-v1"),
				}).addTo(MAP_MAIN);

			// TEMPLATE LIST ITEM - make clones with REGION_LIST_TEMPLATE.cloneNode(true)
			const REGION_LIST_TEMPLATE = document.getElementById("region-list").firstElementChild;
			REGION_LIST_TEMPLATE.remove();

			/* Example of setting region list
			let region_list = document.getElementById("region-list");
			removeAllChildren(region_list); // First, clear existing children (optional)
			
			let item = REGION_LIST_TEMPLATE.cloneNode(true); // Make a copy
			item.getElementsByClassName("region-list-name")[0].innerHTML = "Anne Arundel County"; // Set its text
			item.getElementsByClassName("region-list-data")[0].innerHTML = "Cases: 420";
			region_list.appendChild(item); // Add it to the list
			*/

			setActiveRegionByName("United States");



			// This function sets what region we should show stats for,
			// as well as what region should be highlighted on the map.
			// Any subregions in the region (ie counties in a state) will be selectable in the map and in the list
			function setActiveRegion(region)
			{
				region_active = region;
				console.log("Called setActiveRegion() for region " + getRegionName(region) + " (fips=" + getRegionFipsCode(region) + ")");

				// Set the titles and the stats
				document.getElementById("region-title").innerHTML = getRegionName(region);
				document.getElementById("stats-cases").innerHTML = getRegionCases(region).toLocaleString();
				document.getElementById("stats-deaths").innerHTML = getRegionDeaths(region).toLocaleString();
				document.getElementById("stats-vaccinations").innerHTML = getRegionVaccinations(region).toLocaleString();

				document.getElementById("tab-button-stats").click(); // TODO: If the back button was clicked, navigate to the list tab instead
				document.getElementById("tab-button-back").hidden = !getRegionHasParent(region); // If the region has no parent, hide the back button
				let region_fips = document.getElementById("region-fips");
				let tab_button_list = document.getElementById("tab-button-list");
				switch (getRegionType(region)) // Sets the fips code for states and counties, and sets the title of the List tab
				{
					case 0:
						region_fips.hidden = true; // Countries have no fips code
						tab_button_list.innerHTML = "List of States";
						break;
					case 1:
						region_fips.firstElementChild.innerHTML = getRegionFipsCode(region);
						region_fips.hidden = false;
						tab_button_list.innerHTML = "List of Counties";
						break;
					case 2:
						region_fips.firstElementChild.innerHTML = getRegionFipsCode(region);
						region_fips.hidden = false;
						break;
				}
				tab_button_list.hidden = false;

				// Clear the map of all geo data and re-add it all
				MAP_MAIN_GEO.clearLayers();
				removeAllChildren(document.getElementById("region-list")); // Clear the list so we can re-insert all the elements
				forAllRegionsInParent(region, function(subregion) // For each child region...
				{
					MAP_MAIN_GEO.addData(getRegionGeoJSON(subregion)); // Add its geo data to the map

					// And also insert it into the sidebar list
					let item = REGION_LIST_TEMPLATE.cloneNode(true);
					item.getElementsByClassName("region-list-name")[0].innerHTML = getRegionName(subregion);
					let item_data = item.getElementsByClassName("region-list-data")[0];
					switch (document.getElementById("sort-by").value)
					{
						case "deaths":
							item_data.innerHTML = "Deaths: " + getRegionDeaths(subregion).toLocaleString();
							break;
						case "vaccinations":
							item_data.innerHTML = "Vaccinations: " + getRegionVaccinations(subregion).toLocaleString();
							break;
						default:
							item_data.innerHTML = "Cases: " + getRegionCases(subregion).toLocaleString();
							break;
					}
					item.dataset.fips = getRegionFipsCode(subregion);
					document.getElementById("region-list").appendChild(item);
				}, function() // If no subregions exist (the current region is a county)
				{
					tab_button_list.hidden = true;
					MAP_MAIN_GEO.addData(getRegionGeoJSON(region));
				});
				
				try
				{
					// Leaflet gets big mad if we try to flyToBounds() before we setView().
					// Why can't it just make the first call to flyToBounds() behave like setView()? I dunno.
					// It also has no way of detecting if setView() has yet been called.
					// So while this is probably not a good way to do this, idfc
					MAP_MAIN.flyToBounds(MAP_MAIN_GEO.getBounds());
				} catch (e)
				{
					MAP_MAIN.fitBounds(MAP_MAIN_GEO.getBounds());
				}
			}
			// Helper functions
			function setActiveRegionByFips(fips, fail = () => console.warn("Unknown fips code " + fips))
			{ forRegion(fips, setActiveRegion, fail); }
			function setActiveRegionByName(name, fail = () => console.warn("Unknown region name " + name))
			{ forRegionByName(name, setActiveRegion, fail); }
			function setActiveRegionParent(region, fail = () => console.warn("Region" + getRegionName(region) + " has no parent"))
			{ forRegionParent(region, setActiveRegion, fail); }

			function onEachRegionFeature(feature, layer)
			{
				layer.bindTooltip(getRegionName(feature));
				layer.on("click", function(e) { setActiveRegionByFips(getRegionFipsCode(this)); }, feature);
			}
		</script>
	</body>
</html>